{{- $giscus := .Site.Params.giscus -}}
{{- if and $giscus $giscus.enable -}}
<section id="comments" class="comments">
  <script
    src="https://giscus.app/client.js"
    data-repo="{{ $giscus.repo }}"
    data-repo-id="{{ $giscus.repoId }}"
    data-category="{{ $giscus.category }}"
    data-category-id="{{ $giscus.categoryId }}"
    data-mapping="{{ $giscus.mapping | default "pathname" }}"
    data-reactions-enabled="{{ $giscus.reactionsEnabled | default "1" }}"
    data-emit-metadata="{{ $giscus.emitMetadata | default "0" }}"
    data-input-position="{{ $giscus.inputPosition | default "bottom" }}"
    data-theme="{{ $giscus.theme | default "preferred_color_scheme" }}"
    data-lang="{{ $giscus.lang | default "en" }}"
    {{ with $giscus.loading }}data-loading="{{ . }}"{{ end }}
    crossorigin="anonymous"
    async
  ></script>
  <noscript>Please enable JavaScript to load the comments.</noscript>
</section>
<script>
  (function () {
    "use strict";

    // Keep the embedded widget aligned with the site's theme toggle.
    var docEl = document.documentElement;
    var observer = null;
    var retryTimeout = null;

    var getTheme = function () {
      return docEl.getAttribute("data-theme") === "dark" ? "dark" : "light";
    };

    var postThemeMessage = function () {
      var frame = document.querySelector("iframe.giscus-frame");
      if (!frame) {
        return false;
      }
      frame.contentWindow.postMessage(
        { giscus: { setConfig: { theme: getTheme() } } },
        "https://giscus.app"
      );
      return true;
    };

    var syncTheme = function () {
      if (retryTimeout !== null) {
        window.clearTimeout(retryTimeout);
        retryTimeout = null;
      }
      if (postThemeMessage()) {
        return;
      }
      retryTimeout = window.setTimeout(syncTheme, 200);
    };

    var watchThemeChanges = function () {
      if (observer) {
        return;
      }
      observer = new MutationObserver(function (mutations) {
        for (var i = 0; i < mutations.length; i++) {
          if (mutations[i].attributeName === "data-theme") {
            syncTheme();
            break;
          }
        }
      });
      observer.observe(docEl, { attributes: true, attributeFilter: ["data-theme"] });
    };

    if (document.readyState === "loading") {
      document.addEventListener(
        "DOMContentLoaded",
        function () {
          syncTheme();
          watchThemeChanges();
        },
        { once: true }
      );
    } else {
      syncTheme();
      watchThemeChanges();
    }

    window.addEventListener("message", function (event) {
      if (event.origin !== "https://giscus.app") {
        return;
      }
      if (!event.data || !event.data.giscus) {
        return;
      }
      var payload = event.data.giscus;
      if (
        payload === "ready" ||
        (typeof payload === "object" && payload.ready)
      ) {
        syncTheme();
      }
    });
  })();
</script>
{{- end -}}
